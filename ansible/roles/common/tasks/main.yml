---
- name: Update apt cache
  apt:
    update_cache: yes

- name: Create sysctl config for Kubernetes
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
    owner: root
    group: root
    mode: '0644'

- name: Load br_netfilter kernel module
  community.general.modprobe:
    name: br_netfilter
    state: present
  become: true

- name: Apply sysctl params from k8s.conf
  command: sysctl --system

- name: Install apt-transport-https, curl, and other dependencies
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
      - gnupg
      - gpg
    state: present

- name: Download CRI-O GPG key from official openSUSE repo
  become: yes
  ansible.builtin.get_url:
    url: "https://download.opensuse.org/repositories/isv:/cri-o:/stable:/{{ crio_version }}/deb/Release.key"
    dest: /tmp/crio-release.key
    mode: '0644'

- name: Convert CRI-O GPG key to dearmored format for apt
  become: yes
  ansible.builtin.command:
    cmd: "gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg /tmp/crio-release.key"
  args:
    creates: /etc/apt/keyrings/cri-o-apt-keyring.gpg

- name: Remove temporary CRI-O GPG key file
  become: yes
  ansible.builtin.file:
    path: /tmp/crio-release.key
    state: absent

- name: Add CRI-O apt repository for version {{ crio_version }}
  become: yes
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://download.opensuse.org/repositories/isv:/cri-o:/stable:/{{ crio_version }}/deb/ /"
    filename: cri-o
    state: present
    update_cache: yes

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
- name: Install CRI-O
  apt:
    name:
      - cri-o
    state: present
- name: Enable and start CRI-O service
  systemd:
    name: cri-o
    enabled: yes
    state: started

- name: Download Kubernetes GPG key
  ansible.builtin.get_url:
    url: "https://pkgs.k8s.io/core:/stable:/{{ kubernetes_version }}/deb/Release.key"
    dest: /tmp/kubernetes-release.key
    mode: '0644'

- name: Convert Kubernetes GPG key to dearmored format
  ansible.builtin.command:
    cmd: "gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg /tmp/kubernetes-release.key"
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Remove temporary Kubernetes GPG key
  ansible.builtin.file:
    path: /tmp/kubernetes-release.key
    state: absent

- name: Add Kubernetes apt repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/{{ kubernetes_version }}/deb/ /"
    filename: kubernetes
    state: present
    update_cache: yes

- name: Install Kubernetes components
  apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    allow_downgrade: yes

- name: Hold Kubernetes packages at current version
  command: apt-mark hold kubelet kubeadm kubectl
  changed_when: false

- name: Disable swap
  command: swapoff -a

- name: Ensure swap is disabled on reboot
  cron:
    name: "Disable swap on reboot"
    special_time: reboot
    job: /sbin/swapoff -a