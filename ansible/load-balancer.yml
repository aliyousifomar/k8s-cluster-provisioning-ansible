---
- name: Deploy HAProxy load balancer for Kubernetes control plane
  hosts: loadbalancer_vm
  become: yes
  vars:
    kubernetes_api_port: 6443
    control_plane_nodes:
      - ip: 192.168.3.2
        name: master1
      - ip: 192.168.3.3
        name: master2
      - ip: 192.168.3.4
        name: master3

  tasks:
    - name: Install HAProxy
      apt:
        name: haproxy
        state: present
        update_cache: yes

    - name: Configure HAProxy for Kubernetes API server load balancing
      copy:
        dest: /etc/haproxy/haproxy.cfg
        content: |
          global
              log /dev/log    local0
              log /dev/log    local1 notice
              chroot /var/lib/haproxy
              stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
              stats timeout 30s
              user haproxy
              group haproxy
              daemon

          defaults
              log     global
              mode    tcp
              option  tcplog
              option  dontlognull
              timeout connect 5s
              timeout client  50s
              timeout server  50s
              errorfile 400 /etc/haproxy/errors/400.http
              errorfile 403 /etc/haproxy/errors/403.http
              errorfile 408 /etc/haproxy/errors/408.http
              errorfile 500 /etc/haproxy/errors/500.http
              errorfile 502 /etc/haproxy/errors/502.http
              errorfile 503 /etc/haproxy/errors/503.http
              errorfile 504 /etc/haproxy/errors/504.http

          frontend kubernetes-apiserver
              bind *:{{ kubernetes_api_port }}
              default_backend kubernetes-apiserver-backend

          backend kubernetes-apiserver-backend
              balance roundrobin
              option tcp-check
          {% for node in control_plane_nodes %}
              server {{ node.name }} {{ node.ip }}:{{ kubernetes_api_port }} check
          {% endfor %}

    - name: Restart and enable HAProxy service
      systemd:
        name: haproxy
        state: restarted
        enabled: yes

    - name: Verify API server load balancer is reachable
      wait_for:
        host: "{{ ansible_default_ipv4.address }}"
        port: "{{ kubernetes_api_port }}"
        timeout: 10
